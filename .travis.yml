language: node_js
node_js:
  - "10"
  # - node

os:
- linux
# osx would be great, but travis only supports docker for linux

addons:
  apt:
    update: true
    sources:
      - sourceline: "deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main"
        key_url: https://packages.microsoft.com/keys/microsoft.asc
    packages:
      - code

env:
  # Will override the Travis web UI settings.
  - project_types="node.js"
  - project_types="spring"
  - project_types="microprofile"
  - project_types="go"
  - project_types="python"

sudo: true
cache: npm

before_install:
# VS Code requires this to run tests on travis linux
# https://vscode-docs.readthedocs.io/en/latest/extensions/testing-extensions/
  - if [ $TRAVIS_OS_NAME == "linux" ]; then
      export CXX="g++-4.9" CC="gcc-4.9" DISPLAY=:99.0;
      sh -e /etc/init.d/xvfb start;
      sleep 3;
    fi

script:
- code --version
- code --install-extension "vscjava.vscode-java-debug" --force
- cd dev/
# install and compile (vsce package does this too, but it won't show the compiler errors)
- npm run vscode:prepublish || travis_terminate 1
# run tests
- ../travis-scripts/run-tests.sh || travis_terminate 1
# package into .vsix
- npm i -g vsce
- vsce package

after_success:
# copy the vsix to the script dir and cd into it
- export artifact_name="$(basename *.vsix)"
- mv -v $artifact_name ../travis-scripts/
- cd ../travis-scripts/
# will exit immediately if not a deploy build
- ./deploy.sh || >&2 echo "Deploy failed!"


notifications:
  email:
    recipients:
      - timetchells@ibm.com
      # - devexbld@us.ibm.com
    on_success: change
    on_failure: change
