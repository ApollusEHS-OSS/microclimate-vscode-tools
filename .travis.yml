language: node_js
node_js:
  - node

os:
- linux

env:
  # Test parameters
  - project_types="node.js"

sudo: true
cache: npm

before_install:
# VS Code requires this to run tests on travis linux
# https://vscode-docs.readthedocs.io/en/latest/extensions/testing-extensions/
  - if [ $TRAVIS_OS_NAME == "linux" ]; then
      export CXX="g++-4.9" CC="gcc-4.9" DISPLAY=:99.0;
      sh -e /etc/init.d/xvfb start;
      sleep 3;
    fi

script:
- cd dev/
# install and compile
- npm run vscode:prepublish || travis_terminate 1;
# run tests
- sudo -E ../script/install-microclimate.sh
- export CODE_TESTS_WORKSPACE="${HOME}/microclimate-workspace/"
# https://stackoverflow.com/a/29903645/
- n=$(which node);
  n=${n%/bin/node};
  chmod -R 755 $n/bin/*;
  sudo cp -r $n/{bin,lib,share} /usr/local
- sudo -E $(which npm) test --verbose || travis_terminate 1;
# package into .vsix
- npm i -g vsce
- vsce package

after_success:
# copy the vsix to the script dir and cd into it
- export artifact_name="$(basename *.vsix)"
- mv -v $artifact_name ../script/
- cd ../script/
# will exit immediately if not a deploy build
- ./deploy.sh || >&2 echo "Deploy failed!"


notifications:
  email:
    recipients:
      - timetchells@ibm.com
      # - devexbld@us.ibm.com
    on_success: change
    on_failure: change